<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../neon-animation/animations/cascaded-animation.html">

<!--
`paper-fab-speed-dial`
A floating action button flinging out related actions

@demo demo/index.html
-->

<dom-module id="paper-fab-speed-dial">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-reverse">
    :host {
      @apply --layout-vertical-reverse;
      position: absolute;
      bottom: 10px;
      right: 10px;
      @apply --paper-fab-speed-dial;
    }

    [hidden] {
      display: none !important;
    }

    #content,
    #content ::slotted(div) {
      @apply --layout-vertical-reverse;
    }

    ::slotted([mini]) {
      margin: 0px 8px 10px 8px;
    }

    ::slotted([hidden]) {
      display: none !important;
    }

    </style>

    <slot></slot>
    <div id="content">
      <slot id="contentSlot" name="dropdown-content"></slot>
    </div>

  </template>

  <script> {
    const isElement = (node) => node.nodeType === 1;

    class PaperFabSpeedDial extends Polymer.mixinBehaviors([
      Polymer.NeonAnimationRunnerBehavior,
    ], Polymer.Element) {
      static get is() {return 'paper-fab-speed-dial';}

      static get properties() {
        return {

          active: {
            type: Boolean,
            value: false,
            notify: true,
            reflectToAttribute: true,
          },

          animationConfig: {
            type: Object,
            value: null,
          },

        };
      }

      connectedCallback() {
        super.connectedCallback();
        var button = this._getTriggerElement();
        var menu = this._getDropdownContent()[0];
        menu.hidden = !this.active;
        button.addEventListener('tap', this.toggle.bind(this));
        this.addEventListener('neon-animation-finish', this._onNeonAnimationFinish.bind(this));
        var items = this._getDropdownContent();
        var array = [...items];
        var reversed = [...items].reverse();
        this.animationConfig = {
          'entry': {
            name: 'cascaded-animation',
            animation: 'scale-up-animation',
            nodes: array,
          },
          'exit': {
            name: 'cascaded-animation',
            animation: 'scale-down-animation',
            nodes: reversed,
          },
        };
      }

      toggle() {
        var menu = this._getDropdownContent()[0];
        menu.hidden = false;
        this.active = !this.active;
        var animation = this.active ? 'entry' : 'exit';
        this.playAnimation(animation);
      }

      _onNeonAnimationFinish() {
        var menu = this._getDropdownContent()[0];
        menu.hidden = !this.active;
      }

      _getTriggerElement() {
        const nodes = this.shadowRoot.querySelector('slot:first-of-type')
          .assignedNodes()
          .filter(isElement);
        return nodes[0];
      }

      _getDropdownContent() {
        const nodes = this.shadowRoot.querySelector('slot[name="dropdown-content"]')
          .assignedNodes()
          .filter(isElement);
        return nodes;
      }
    }

    customElements.define(PaperFabSpeedDial.is, PaperFabSpeedDial);
  }

  </script>
</dom-module>
