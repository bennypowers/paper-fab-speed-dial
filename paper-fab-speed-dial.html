<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../neon-animation/animations/cascaded-animation.html">

<!--
`paper-fab-speed-dial`
A floating action button flinging out related actions

@demo demo/index.html
-->

<dom-module id="paper-fab-speed-dial">
  <template>
    <style>

    :host {
      display: flex;
      flex-flow: column-reverse;
      position: var(--paper-fab-speed-dial-position, absolute);
      bottom: var(--paper-fab-speed-dial-bottom, 10px);
      right: var(--paper-fab-speed-dial-right, 10px);
      @apply --paper-fab-speed-dial;
    }

    ::slotted(div) {
      display: grid;
      grid-row-gap: 10px;
    }

    #content {
      margin: 0px 8px 10px 8px;
    }

    [hidden],
    ::slotted([hidden]) {
      display: none !important;
    }

    </style>

    <slot></slot>

    <div id="content">
      <slot id="contentSlot" name="dropdown-content"></slot>
    </div>

  </template>

  <script> {
    const isElement = (node) => node.nodeType === 1;

    class PaperFabSpeedDial extends Polymer.mixinBehaviors([
      Polymer.NeonAnimationRunnerBehavior,
    ], Polymer.Element) {
      static get is() {return 'paper-fab-speed-dial';}

      static get properties() {
        return {

          active: {
            type: Boolean,
            value: false,
            notify: true,
            reflectToAttribute: true,
          },

          animationConfig: {
            type: Object,
            value: null,
          },

        };
      }

      connectedCallback() {
        super.connectedCallback();
        // eslint-disable-next-line max-len
        this.addEventListener('neon-animation-finish', this._onNeonAnimationFinish.bind(this));
        const button = this._getTriggerElement();
              button.addEventListener('tap', this.toggle.bind(this));
        const menu = this._getDropdownContent()[0];
              menu.hidden = !this.active;
        const array = Array.from(menu.children);
        const reversed = [...array].reverse();
        this.animationConfig = {
          'entry': {
            name: 'cascaded-animation',
            animation: 'scale-up-animation',
            nodes: reversed,
          },
          'exit': {
            name: 'cascaded-animation',
            animation: 'scale-down-animation',
            nodes: array,
          },
        };
      }

      toggle() {
        const menu = this._getDropdownContent()[0];
              menu.hidden = false;
        this.active = !this.active;
        const animation = this.active ? 'entry' : 'exit';
        this.playAnimation(animation);
      }

      _onNeonAnimationFinish() {
        const menu = this._getDropdownContent()[0];
              menu.hidden = !this.active;
      }

      _getTriggerElement() {
        const nodes = this.shadowRoot.querySelector('slot:first-of-type')
          .assignedNodes()
          .filter(isElement);
        return nodes[0];
      }

      _getDropdownContent() {
        const nodes = this.shadowRoot.querySelector('slot[name="dropdown-content"]')
          .assignedNodes()
          .filter(isElement);
        return nodes;
      }
    }

    customElements.define(PaperFabSpeedDial.is, PaperFabSpeedDial);
  }

  </script>
</dom-module>
